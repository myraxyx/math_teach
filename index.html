<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Teacher RPG - Ujian Nasional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0A3323 0%, #839958 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Header */
        .game-header {
            background: linear-gradient(90deg, #F7F4D5, #D3968C);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-counter {
            font-size: 24px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 50px;
        }

        .topic-display {
            font-size: 20px;
            font-weight: bold;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            padding: 20px;
            min-height: 500px;
        }

        /* Left Column */
        .classroom-section {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            border: 3px solid #4CAF50;
        }

        .student-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .student-item:hover {
            transform: translateX(5px);
            border-color: #000000;
        }

        .student-item.truant {
            background: #fff3e0;
            border-color: #FF9800;
        }

        .student-item.sent-bk {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .student-item.has-question {
            background: #e3f2fd;
            border-color: #2196F3;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
            100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
        }

        /* Center Column */
        .whiteboard-container {
            background: #105666;
            border-radius: 10px;
            padding: 20px;
            color: white;
            position: relative;
        }

        .question-text {
            font-size: 18px;
            line-height: 1.5;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-height: 100px;
        }

        .answer-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #000000;
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .answer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .answer-btn.correct {
            background: #4CAF50;
            border-color: #388E3C;
        }

        .answer-btn.incorrect {
            background: #642025;
            border-color: #642025;
        }

        .timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }

        .exam-timer {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }

        /* Right Column */
        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stats-box {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            border: 3px solid;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        /* Controls */
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-top: 3px solid #ddd;
        }

        .control-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }

        .btn-start {
            background: #C87D87;
            color: white;
        }

        .btn-next {
            background: #6B7556;
            color: white;
        }

        .btn-help {
            background: #E5BCA9;
            color: white;
        }

        .btn-restart {
            background: #2196F3;
            color: white;
        }

        .btn-next-day {
            background: #9C27B0;
            color: white;
        }

        .btn-ask {
            background: #FF9800;
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Overlays */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .overlay-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .material-content {
            font-size: 16px;
            line-height: 1.6;
            margin: 20px 0;
        }

        .formula-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #2196F3;
            font-family: 'Cambria Math', serif;
        }

        /* Day 4 Exam Styles */
        .exam-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .exam-option {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border: 3px solid transparent;
        }

        .exam-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .exam-option.patrol {
            border-color: #4CAF50;
        }

        .exam-option.roam {
            border-color: #FF9800;
        }

        /* Risk Indicator */
        .risk-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 100;
            display: none;
        }

        /* Feedback */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            display: none;
            animation: fadeInOut 3s;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        .feedback.correct {
            background: #4CAF50;
        }

        .feedback.incorrect {
            background: #F44336;
        }

        .feedback.score {
            background: #2196F3;
        }

        /* Student Question Indicator */
        .question-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 100;
            display: none;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Teacher Score Display */
        .teacher-score {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 100;
            display: none;
        }

        /* Question Counter */
        .question-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }

        /* Restart Popup Styles */
        .restart-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .restart-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            animation: popupScale 0.5s ease-out;
        }

        @keyframes popupScale {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .restart-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn-yes {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }

        .btn-no {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }

        .btn-yes:hover, .btn-no:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .achievement-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid gold;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px gold; }
            50% { box-shadow: 0 0 20px gold; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }
        
        /* Difficulty Warning */
        .difficulty-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            z-index: 2001;
            text-align: center;
            max-width: 500px;
            width: 90%;
            display: none;
        }
        
        .warning-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Difficulty Warning -->
    <div class="difficulty-warning" id="difficultyWarning">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <h2>PERINGATAN TINGKAT KESULITAN!</h2>
        <p style="margin: 15px 0; font-size: 18px;">
            <strong>GAME INI SULIT!</strong>
        </p>
        <p style="margin: 10px 0;">
            ‚Ä¢ Anda harus menjawab <strong>minimal 12 dari 20 soal</strong> dengan benar
        </p>
        <p style="margin: 10px 0;">
            ‚Ä¢ Jika hanya 4-8 jawaban benar: <strong>DIPECAT!</strong>
        </p>
        <p style="margin: 10px 0;">
            ‚Ä¢ Pertanyaan siswa akan muncul <strong>SANGAT CEPAT</strong>
        </p>
        <p style="margin: 20px 0; color: #FF6B6B;">
            Siap untuk tantangan?
        </p>
        <button class="control-btn" onclick="closeWarning()" style="background: #FF9800; color: white;">
            YA, SAYA SIAP!
        </button>
    </div>

    <!-- Risk Indicator -->
    <div class="risk-indicator" id="riskIndicator">
        üé≤ Risiko: <span id="riskValue">30%</span>
    </div>

    <!-- Teacher Score -->
    <div class="teacher-score" id="teacherScore">
        üìä Skor Guru: <span id="scoreValue">0</span><br>
        ‚úÖ Benar: <span id="totalCorrectValue">0</span>/20
    </div>

    <!-- Student Question Indicator -->
    <div class="question-indicator" id="questionIndicator">
        ‚ùì <span id="questionStudent">Siswa</span> ingin bertanya! Klik pada siswa yang berkedip
    </div>

    <!-- Restart Popup -->
    <div class="restart-popup" id="restartPopup">
        <div class="restart-content">
            <h2 id="restartTitle">üéÆ Permainan Selesai!</h2>
            
            <div id="finalStats" style="margin: 20px 0;">
                <!-- Final stats will be added here -->
            </div>

            <div class="stats-grid" id="statsGrid">
                <!-- Stats grid will be added here -->
            </div>

            <div id="achievementBadge" class="achievement-badge" style="display: none;">
                <!-- Achievement badge will be added here -->
            </div>

            <h3>Main Lagi?</h3>
            <div class="restart-buttons">
                <button class="btn-yes" onclick="confirmRestart()">
                    ‚úÖ Ya, Main Lagi!
                </button>
                <button class="btn-no" onclick="declineRestart()">
                    ‚ùå Tidak, Terima Kasih
                </button>
            </div>
            
            <p style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
                Skor tertinggi: <span id="highScoreValue">0</span>
            </p>
        </div>
    </div>

    <!-- Main Game Container -->
    <div class="game-container">
        <!-- Header -->
        <div class="game-header">
            <h1>üéì Math Teacher RPG - HARD MODE</h1>
            <div class="header-right">
                <div class="day-counter" id="dayCounter">Hari 1/4</div>
                <div class="topic-display" id="topicDisplay">Permutasi & Kombinasi</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left: Students -->
            <div class="classroom-section">
                <h2>üë®‚Äçüéì Siswa</h2>
                <div id="studentList">
                    <!-- Students will be added here -->
                </div>
            </div>

            <!-- Center: Whiteboard -->
            <div class="whiteboard-container">
                <div class="question-counter" id="questionCounter">Pertanyaan 1/10</div>
                <div class="timer" id="timer">‚è∞ 25s</div>
                <div class="exam-timer" id="examTimer" style="display: none;">‚è≥ Ujian: 2:00</div>
                <div class="question-text" id="questionText">
                    Selamat datang! Klik "Mulai Hari" untuk memulai pelajaran.
                </div>
                <div class="answer-options" id="answerOptions">
                    <!-- Answer options will be added here -->
                </div>
            </div>

            <!-- Right: Stats -->
            <div class="stats-section">
                <div class="stats-box">
                    <h3>üèÜ Ranking</h3>
                    <div id="rankingList">
                        <!-- Ranking will be added here -->
                    </div>
                </div>
                <div class="stats-box">
                    <h3>üìä Progress</h3>
                    <div>Total Benar: <span id="totalCorrectDisplay">0</span>/20</div>
                    <div>Rata-rata: <span id="averageScore">0%</span></div>
                    <div>Pertanyaan hari ini: <span id="questionsAnswered">0/10</span></div>
                </div>
                <div class="stats-box">
                    <h3>üòä Guru</h3>
                    <div>Kesabaran: <span id="patienceValue">100%</span></div>
                    <div>Semangat: <span id="moraleValue">100</span></div>
                    <div>Status: <span id="teacherStatus">Baik</span></div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="game-controls">
            <button class="control-btn btn-start" id="startDayBtn" onclick="startDay()">
                Mulai Hari
            </button>
            <button class="control-btn btn-next" id="nextQuestionBtn" onclick="nextQuestion()" disabled style="display: none;">
                Lanjut Pertanyaan
            </button>
            <button class="control-btn btn-ask" id="askBtn" onclick="answerStudentQuestion()" disabled>
                Jawab Pertanyaan Siswa
            </button>
            <button class="control-btn btn-restart" id="restartBtn" onclick="restartGame()" style="display: none;">
                Mulai Ulang Hari
            </button>
            <button class="control-btn btn-help" onclick="showHelp()">
                Bantuan
            </button>
        </div>
    </div>

    <!-- Material Overlay -->
    <div class="overlay" id="materialOverlay">
        <div class="overlay-content">
            <h2 id="materialTitle">Materi Hari 1</h2>
            <div class="material-content" id="materialContent">
                <!-- Material will be added here -->
            </div>
            <button class="control-btn btn-start" onclick="continueToQuestions()" style="width: 100%; margin-top: 20px;">
                Lanjut ke Pertanyaan
            </button>
        </div>
    </div>

    <!-- Student Question Overlay -->
    <div class="overlay" id="studentQuestionOverlay">
        <div class="overlay-content">
            <h2>‚ùì Pertanyaan Siswa</h2>
            <div id="studentQuestionContent" style="margin: 20px 0; padding: 20px; background: #e3f2fd; border-radius: 10px;">
                <!-- Student question will be added here -->
            </div>
            <div id="studentQuestionOptions" style="margin: 20px 0;">
                <!-- Answer options for student question -->
            </div>
            <button class="control-btn btn-next" onclick="closeStudentQuestion()" style="width: 100%;">
                Kembali ke Pelajaran
            </button>
        </div>
    </div>

    <!-- Day Complete Overlay -->
    <div class="overlay" id="dayCompleteOverlay">
        <div class="overlay-content">
            <h2>üéâ Hari Selesai!</h2>
            <div style="margin: 20px 0; padding: 20px; background: #e8f5e9; border-radius: 10px;">
                <h3>üìä Hasil Hari Ini:</h3>
                <p>Pertanyaan dijawab: <span id="dayQuestionsAnswered">0</span>/<span id="dayTotalQuestions">10</span></p>
                <p>Jawaban benar: <span id="dayCorrectAnswers">0</span></p>
                <p>Total Benar: <span id="totalCorrectSoFar">0</span>/<span id="totalQuestionsSoFar">10</span></p>
                <p>Pertanyaan siswa terjawab: <span id="dayStudentQuestions">0</span></p>
                <p>Skor hari ini: <span id="dayScore">0</span></p>
                <p>Total Skor Guru: <span id="totalTeacherScore">0</span></p>
            </div>
            <button class="control-btn btn-next-day" onclick="autoNextDay()" style="width: 100%;">
                Lanjut ke Hari Berikutnya
            </button>
        </div>
    </div>

    <!-- Exam Overlay -->
    <div class="overlay" id="examOverlay">
        <div class="overlay-content">
            <h2>üéì UJIAN NASIONAL - Hari 4</h2>
            <p style="margin: 15px 0;">Hari ini menentukan nasib karir Anda sebagai guru!</p>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="examAvgScore">0.0</div>
                    <div>Rata-rata Nilai</div>
                </div>
                <div style="background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="examPassRate">0%</div>
                    <div>Tingkat Kelulusan</div>
                </div>
                <div style="background: #ffebee; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="examRisk">0%</div>
                    <div>Risiko Dipecat</div>
                </div>
            </div>
            
            <div class="exam-options">
                <div class="exam-option patrol" onclick="startPatrol()">
                    <h3>üö® Patroli Sekolah</h3>
                    <p>Tangkap siswa bolos dan kirim ke BK untuk +10 skor!</p>
                    <p style="color: #666; margin-top: 10px;">‚è±Ô∏è 30 menit</p>
                </div>
                <div class="exam-option roam" onclick="startRoaming()">
                    <h3>üèÉ‚Äç‚ôÄÔ∏è Jalan-jalan</h3>
                    <p>Beli es krim dan jalan-jalan di sekolah.</p>
                    <p style="color: #666; margin-top: 10px;">‚è±Ô∏è 30 menit</p>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                <h4>üìã Waktu Ujian: 2 jam</h4>
                <p>Setiap aksi (patroli/jalan-jalan) menghabiskan 30 menit.</p>
                <p>Waktu tersisa: <span id="examTimeLeft">2:00</span></p>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="control-btn btn-start" onclick="finishExam()">
                    Selesaikan Ujian
                </button>
            </div>
        </div>
    </div>

    <!-- Patrol Overlay -->
    <div class="overlay" id="patrolOverlay">
        <div class="overlay-content">
            <h2>üö® Patroli Sekolah</h2>
            <div id="patrolContent" style="margin: 20px 0;">
                <!-- Patrol content will be added here -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <p>Waktu tersisa: <span id="patrolTimeLeft">2:00</span></p>
                <button class="control-btn" onclick="endPatrol()">
                    Kembali ke Ujian
                </button>
            </div>
        </div>
    </div>

    <!-- Roam Overlay -->
    <div class="overlay" id="roamOverlay">
        <div class="overlay-content">
            <h2>üèÉ‚Äç‚ôÄÔ∏è Jalan-jalan</h2>
            <div style="text-align: center; margin: 20px 0;">
                <h3>üç¶ Toko Es Krim</h3>
                <div style="display: flex; justify-content: center; gap: 15px; margin: 15px 0;">
                    <button class="control-btn" style="background: #FFD700;" onclick="buyIceCream('vanilla')">
                        üç® Vanila<br>+10 Semangat
                    </button>
                    <button class="control-btn" style="background: #8B4513; color: white;" onclick="buyIceCream('chocolate')">
                        üç´ Coklat<br>+15 Semangat
                    </button>
                    <button class="control-btn" style="background: #FF69B4;" onclick="buyIceCream('strawberry')">
                        üçì Stroberi<br>+20 Semangat
                    </button>
                </div>
            </div>
            <div style="text-align: center;">
                <p>üí™ Semangat: <span id="moraleDisplay">100</span></p>
                <p>Waktu tersisa: <span id="roamTimeLeft">2:00</span></p>
                <button class="control-btn" onclick="endRoaming()" style="margin-top: 20px;">
                    Kembali ke Ujian
                </button>
            </div>
        </div>
    </div>

    <!-- Result Overlay -->
    <div class="overlay" id="resultOverlay">
        <div class="overlay-content" id="resultContainer">
            <h2 id="resultTitle">Hasil Ujian</h2>
            <div id="resultMessage" style="margin: 20px 0;">
                <!-- Result message will be added here -->
            </div>
            <div style="text-align: center;">
                <button class="control-btn" onclick="showRestartPopup()">
                    Main Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback -->
    <div class="feedback" id="feedback"></div>

    <script>
        // ========================
        // GAME STATE
        // ========================
        const gameState = {
            currentDay: 1,
            currentQuestion: 0,
            gameActive: false,
            timerActive: false,
            timeLeft: 25, // Reduced from 30
            timerInterval: null,
            autoNextTimer: null,
            questionsAnswered: 0,
            correctAnswers: 0,
            totalCorrectAllDays: 0, // Track correct answers across all days
            totalQuestionsAllDays: 0, // Track total questions
            patience: 100,
            knowledgePoints: 0,
            teacherScore: 0,
            studentQuestionActive: false,
            askingStudent: null,
            studentQuestionsAnswered: 0,
            
            // Day 4 exam state
            examActive: false,
            caughtStudents: [],
            cheatedStudents: [],
            morale: 100,
            riskLevel: 30,
            iceCreamBought: false,
            examResults: [],
            examTimeLeft: 120,
            examTimerInterval: null,
            remainingActions: 4,
            
            // Game result state
            finalResult: null,
            finalPassRate: 0,
            finalStats: null,
            
            // Student question tracking
            studentQuestionTimers: [],
            questionDelay: 0,
            
            // Difficulty settings
            difficulty: "HARD",
            requiredCorrect: 12, // Need at least 12/20 correct
            warningThreshold: 8, // If less than 8, automatic fail
            perfectBonus: 18 // If 18+, big bonus
        };

        // High score system
        let highScore = localStorage.getItem('mathTeacherHighScore') || 0;

        // ========================
        // GAME DATA
        // ========================
        const students = ["Wemmbu", "Spoke", "Parrotx2", "Gojo", "Geto", "Flame"];
        const studentScores = {};
        
        // Additional NPC students for truants
        const npcStudents = ["Rafi", "Dina", "Sari", "Budi", "Andi", "Lina", "Rina", "Doni"];
        
        // Initialize student scores
        students.forEach(student => {
            studentScores[student] = 4.0 + Math.random() * 1.5;
        });

        // Student questions data (hari 2 dan 3 saja)
        const studentQuestions = {
            day2: [
                {
                    student: "Flame",
                    question: "Pak, kenapa peluang selalu antara 0 dan 1?",
                    options: [
                        "Karena itu definisi probabilitas",
                        "Agar mudah dihitung",
                        "Kebiasaan matematikawan",
                        "Tidak selalu, bisa lebih dari 1"
                    ],
                    correct: 0,
                    explanation: "Peluang 0 = mustahil, 1 = pasti. Ini definisi dasar probabilitas."
                },
                {
                    student: "Wemmbu",
                    question: "Pak, kalau lempar 3 koin, peluang dapat 2 gambar 1 angka?",
                    options: ["1/8", "3/8", "1/2", "5/8"],
                    correct: 1,
                    explanation: "Ruang sampel 8, kemungkinan: GGA, GAG, AGG ‚Üí 3/8"
                },
                {
                    student: "Spoke",
                    question: "Pak, apa bedanya peluang empiris dan teoretis?",
                    options: [
                        "Empiris dari percobaan, teoretis dari teori",
                        "Teoretis lebih akurat",
                        "Sama saja",
                        "Empiris untuk dadu, teoretis untuk koin"
                    ],
                    correct: 0,
                    explanation: "Empiris berdasarkan percobaan nyata, teoretis berdasarkan perhitungan matematis."
                },
                {
                    student: "Parrotx2",
                    question: "Pak, kalau peluang hujan 70%, apakah pasti hujan?",
                    options: ["Pasti", "Tidak pasti", "70% pasti", "Tidak tahu"],
                    correct: 1,
                    explanation: "Peluang 70% berarti kemungkinan besar hujan, tapi tidak pasti."
                },
                {
                    student: "Gojo",
                    question: "Pak, dari 52 kartu, peluang dapat AS atau hati?",
                    options: ["4/52", "13/52", "16/52", "17/52"],
                    correct: 3,
                    explanation: "P(AS) = 4/52, P(hati) = 13/52, P(AS‚à©hati)=1/52, jadi 4/52 + 13/52 - 1/52 = 16/52"
                }
            ],
            day3: [
                {
                    student: "Geto",
                    question: "Pak, kenapa limit penting dalam kalkulus?",
                    options: [
                        "Dasar turunan dan integral",
                        "Untuk hitung kecepatan",
                        "Hanya teori",
                        "Tidak penting"
                    ],
                    correct: 0,
                    explanation: "Limit adalah konsep dasar untuk turunan (perubahan) dan integral (luas)."
                },
                {
                    student: "Flame",
                    question: "Pak, kalau x mendekati 0, berapa sin(x)/x?",
                    options: ["0", "1", "Tak hingga", "Tidak ada"],
                    correct: 1,
                    explanation: "Ini limit trigonometri dasar, hasilnya 1."
                },
                {
                    student: "Wemmbu",
                    question: "Pak, apa artinya limit tak hingga?",
                    options: [
                        "Nilai semakin besar tanpa batas",
                        "Tidak terdefinisi",
                        "Sama dengan tak hingga",
                        "Limit tidak ada"
                    ],
                    correct: 0,
                    explanation: "Limit tak hingga berarti fungsi semakin besar ketika x mendekati nilai tertentu."
                },
                {
                    student: "Spoke",
                    question: "Pak, bagaimana cara hitung limit fungsi pecahan?",
                    options: [
                        "Substitusi langsung dulu",
                        "Faktorkan",
                        "Kalikan sekawan",
                        "Semua benar"
                    ],
                    correct: 3,
                    explanation: "Bisa substitusi dulu, jika 0/0 coba faktorkan atau kalikan sekawan."
                },
                {
                    student: "Parrotx2",
                    question: "Pak, limit kanan dan limit kiri itu apa?",
                    options: [
                        "Dekat dari kanan dan kiri",
                        "Sama saja",
                        "Untuk fungsi diskrit",
                        "Tidak penting"
                    ],
                    correct: 0,
                    explanation: "Limit kanan (x‚Üíc‚Å∫) dan limit kiri (x‚Üíc‚Åª). Jika sama, limit ada."
                }
            ]
        };

        const materialData = {
            day1: {
                title: "Hari 1: Permutasi & Kombinasi",
                content: `
                    <h3>‚ú® Pengertian Dasar</h3>
                    <p><strong>Permutasi</strong> adalah cara menyusun objek dengan memperhatikan urutan.</p>
                    <p><strong>Kombinasi</strong> adalah cara memilih objek tanpa memperhatikan urutan.</p>
                    
                    <div class="formula-box">
                        <p><strong>Permutasi:</strong> P(n,r) = n! / (n-r)!</p>
                        <p><strong>Kombinasi:</strong> C(n,r) = n! / [r!(n-r)!]</p>
                        <p>Dimana n = total objek, r = objek yang dipilih</p>
                    </div>
                    
                    <h3>üéØ Contoh</h3>
                    <p>Permutasi: Susun 5 buku berbeda = 5! = 120 cara</p>
                    <p>Kombinasi: Pilih 3 dari 7 siswa = C(7,3) = 35 cara</p>
                `
            },
            day2: {
                title: "Hari 2: Peluang (Probability)",
                content: `
                    <h3>‚ú® Apa itu Peluang?</h3>
                    <p>Peluang mengukur kemungkinan suatu kejadian terjadi.</p>
                    <p>Nilai antara 0 (mustahil) hingga 1 (pasti).</p>
                    
                    <div class="formula-box">
                        <p><strong>Rumus:</strong> P(A) = n(A) / n(S)</p>
                        <p>P(A) = Peluang kejadian A</p>
                        <p>n(A) = Hasil yang diinginkan</p>
                        <p>n(S) = Total kemungkinan hasil</p>
                    </div>
                    
                    <h3>üéØ Contoh</h3>
                    <p>Peluang angka genap pada dadu: 3/6 = 1/2 = 50%</p>
                    <p>Peluang satu gambar satu angka pada 2 koin: 2/4 = 1/2 = 50%</p>
                `
            },
            day3: {
                title: "Hari 3: Limit Fungsi",
                content: `
                    <h3>‚ú® Apa itu Limit?</h3>
                    <p>Limit menunjukkan nilai yang didekati oleh fungsi saat variabel mendekati nilai tertentu.</p>
                    
                    <div class="formula-box">
                        <p><strong>Notasi:</strong> lim f(x) = L</p>
                        <p>x‚Üíc</p>
                        <p>Artinya: saat x mendekati c, f(x) mendekati L</p>
                    </div>
                    
                    <h3>üéØ Contoh</h3>
                    <p>lim (x¬≤ - 4)/(x - 2) = 4</p>
                    <p>x‚Üí2</p>
                    <p>lim sin(x)/x = 1</p>
                    <p>x‚Üí0</p>
                `
            }
        };

        const questionsData = {
            day1: [
                // 5 SOAL PERMUTASI
                {
                    question: "Berapa banyak cara menyusun 6 buku berbeda di rak?",
                    options: ["36", "120", "720", "5040"],
                    correct: 2,
                    explanation: "Permutasi 6 objek: 6! = 6√ó5√ó4√ó3√ó2√ó1 = 720 cara"
                },
                {
                    question: "Dalam lomba lari 8 peserta, berapa banyak kemungkinan juara 1, 2, dan 3?",
                    options: ["56", "336", "672", "40320"],
                    correct: 1,
                    explanation: "Permutasi P(8,3) = 8√ó7√ó6 = 336 cara"
                },
                {
                    question: "Password 4 digit dengan angka berbeda (0-9), berapa kemungkinan?",
                    options: ["10000", "5040", "3024", "720"],
                    correct: 2,
                    explanation: "Permutasi 4 angka: 10√ó9√ó8√ó7 = 5040"
                },
                {
                    question: "Dari kata 'MATEMATIKA', berapa susunan huruf berbeda?",
                    options: ["151.200", "100.800", "75.600", "50.400"],
                    correct: 0,
                    explanation: "10! / (2!2!2!3!) = 151.200 (M:2, A:3, T:2, E:1, I:1, K:1)"
                },
                {
                    question: "Ada 5 warna bendera, berapa cara membuat sinyal dengan 3 bendera berurutan?",
                    options: ["15", "60", "125", "243"],
                    correct: 1,
                    explanation: "Permutasi P(5,3) = 5√ó4√ó3 = 60 cara",
                },
                // 5 SOAL KOMBINASI
                {
                    question: "Dari 10 siswa, berapa cara memilih 3 siswa untuk jadi panitia?",
                    options: ["30", "120", "720", "604800"],
                    correct: 1,
                    explanation: "Kombinasi C(10,3) = 120 cara"
                },
                {
                    question: "Dalam sebuah tim basket, ada 12 pemain. Berapa cara memilih 5 starter?",
                    options: ["60", "792", "95040", "248832"],
                    correct: 1,
                    explanation: "Kombinasi C(12,5) = 792 cara"
                },
                {
                    question: "Dari 8 titik pada lingkaran, berapa banyak segitiga yang dapat dibentuk?",
                    options: ["56", "336", "672", "40320"],
                    correct: 0,
                    explanation: "Kombinasi C(8,3) = 56 segitiga"
                },
                {
                    question: "Ada 6 pria dan 4 wanita. Berapa cara memilih panitia 3 orang dengan minimal 1 wanita?",
                    options: ["60", "100", "116", "120"],
                    correct: 2,
                    explanation: "Total C(10,3)=120, tanpa wanita C(6,3)=20, jadi 120-20=100"
                },
                {
                    question: "Dalam kotak ada 7 bola berbeda. Berapa cara mengambil 4 bola sekaligus?",
                    options: ["35", "840", "5040", "1680"],
                    correct: 0,
                    explanation: "Kombinasi C(7,4) = 35 cara"
                }
            ],
            day2: [
                {
                    question: "Peluang muncul angka genap pada dadu?",
                    options: ["1/6", "1/3", "1/2", "2/3"],
                    correct: 2,
                    explanation: "Angka genap: 2,4,6 ‚Üí 3/6 = 1/2"
                },
                {
                    question: "Dua koin dilempar, peluang satu gambar satu angka?",
                    options: ["1/4", "1/3", "1/2", "3/4"],
                    correct: 2,
                    explanation: "Kemungkinan: AA, AG, GA, GG ‚Üí 2/4 = 1/2"
                },
                {
                    question: "Dari 52 kartu, peluang dapat AS?",
                    options: ["1/13", "1/4", "1/52", "4/52"],
                    correct: 0,
                    explanation: "Ada 4 AS dari 52 kartu = 4/52 = 1/13"
                },
                {
                    question: "Peluang hujan hari ini 30%, peluang tidak hujan?",
                    options: ["30%", "50%", "70%", "100%"],
                    correct: 2,
                    explanation: "100% - 30% = 70%"
                },
                {
                    question: "Dua dadu, peluang jumlah 7?",
                    options: ["1/6", "1/12", "1/18", "1/36"],
                    correct: 0,
                    explanation: "Kemungkinan: (1,6),(2,5),(3,4),(4,3),(5,2),(6,1) ‚Üí 6/36 = 1/6"
                }
            ],
            day3: [
                {
                    question: "lim (x¬≤-4)/(x-2) saat x‚Üí2?",
                    options: ["0", "2", "4", "Tak terhingga"],
                    correct: 2,
                    explanation: "(x-2)(x+2)/(x-2) = x+2 ‚Üí 4"
                },
                {
                    question: "lim sin(x)/x saat x‚Üí0?",
                    options: ["0", "1", "Tak terhingga", "Tidak ada"],
                    correct: 1,
                    explanation: "Limit trigonometri dasar = 1"
                },
                {
                    question: "lim (3x¬≤ + 2x - 1) saat x‚Üí1?",
                    options: ["2", "3", "4", "5"],
                    correct: 2,
                    explanation: "3(1)¬≤ + 2(1) - 1 = 3 + 2 - 1 = 4"
                },
                {
                    question: "lim (x‚Üí‚àû) dari 1/x?",
                    options: ["0", "1", "‚àû", "Tidak ada"],
                    correct: 0,
                    explanation: "Saat x besar, 1/x mendekati 0"
                },
                {
                    question: "lim (x‚Üí0) dari (1 - cos x)/x?",
                    options: ["0", "1", "1/2", "Tidak ada"],
                    correct: 0,
                    explanation: "Menggunakan identitas trigonometri, hasilnya 0"
                }
            ]
        };

        // ========================
        // CORE GAME FUNCTIONS
        // ========================

        function showDifficultyWarning() {
            document.getElementById('difficultyWarning').style.display = 'block';
        }

        function closeWarning() {
            document.getElementById('difficultyWarning').style.display = 'none';
            updateUI();
        }

        function startDay() {
            if (gameState.currentDay === 4) {
                startExamDay();
                return;
            }
            
            showMaterial();
        }

        function showMaterial() {
            const material = materialData[`day${gameState.currentDay}`];
            document.getElementById('materialTitle').textContent = material.title;
            document.getElementById('materialContent').innerHTML = material.content;
            document.getElementById('materialOverlay').style.display = 'flex';
            document.getElementById('startDayBtn').disabled = true;
            document.getElementById('nextQuestionBtn').style.display = 'none';
        }

        function continueToQuestions() {
            document.getElementById('materialOverlay').style.display = 'none';
            
            gameState.gameActive = true;
            gameState.currentQuestion = 0;
            gameState.timeLeft = 25; // Reduced timer
            
            showQuestion();
            startTimer();
            
            if (gameState.currentDay === 2 || gameState.currentDay === 3) {
                scheduleStudentQuestions();
            }
        }

        function showQuestion() {
            if (!gameState.gameActive) return;
            
            const questions = questionsData[`day${gameState.currentDay}`];
            const question = questions[gameState.currentQuestion];
            
            if (!question) {
                endDay();
                return;
            }
            
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('questionCounter').textContent = `Pertanyaan ${gameState.currentQuestion + 1}/${questions.length}`;
            
            const answerOptions = document.getElementById('answerOptions');
            answerOptions.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.textContent = option;
                button.onclick = () => checkAnswer(index);
                answerOptions.appendChild(button);
            });
        }

        function checkAnswer(selectedIndex) {
            const questions = questionsData[`day${gameState.currentDay}`];
            const question = questions[gameState.currentQuestion];
            const buttons = document.querySelectorAll('.answer-btn');
            
            buttons.forEach(btn => btn.disabled = true);
            stopTimer();
            
            const isCorrect = selectedIndex === question.correct;
            
            buttons.forEach((btn, index) => {
                if (index === question.correct) {
                    btn.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            gameState.questionsAnswered++;
            gameState.totalQuestionsAllDays++;
            
            if (isCorrect) {
                gameState.correctAnswers++;
                gameState.totalCorrectAllDays++;
                gameState.knowledgePoints += 10;
                gameState.teacherScore += 10;
                gameState.patience = Math.min(100, gameState.patience + 5);
                showFeedback("‚úÖ Jawaban Benar! +10 Poin", true);
            } else {
                gameState.patience -= 20; // Increased penalty
                if (gameState.patience <= 0) {
                    gameState.patience = 0;
                    showFeedback("üò° KESABARAN HABIS! -20 Kesabaran", false);
                } else {
                    showFeedback("‚ùå Jawaban Salah! -20 Kesabaran", false);
                }
            }
            
            updateUI();
            
            // Check if performance is critically poor
            checkCriticalPerformance();
            
            clearTimeout(gameState.autoNextTimer);
            gameState.autoNextTimer = setTimeout(() => {
                nextQuestion();
            }, 1500);
        }

        function checkCriticalPerformance() {
            const currentCorrectRate = (gameState.totalCorrectAllDays / gameState.totalQuestionsAllDays) * 100;
            
            if (gameState.totalQuestionsAllDays >= 5 && currentCorrectRate < 40) {
                // Very poor performance
                document.getElementById('teacherStatus').textContent = "KRITIS";
                document.getElementById('teacherStatus').style.color = "#F44336";
                
                if (gameState.totalQuestionsAllDays >= 10 && currentCorrectRate < 30) {
                    showFeedback("‚ö†Ô∏è PERINGATAN: Performa mengajar KRITIS!", false);
                }
            } else if (currentCorrectRate < 60) {
                document.getElementById('teacherStatus').textContent = "Buruk";
                document.getElementById('teacherStatus').style.color = "#FF9800";
            } else if (currentCorrectRate < 75) {
                document.getElementById('teacherStatus').textContent = "Cukup";
                document.getElementById('teacherStatus').style.color = "#FFC107";
            } else {
                document.getElementById('teacherStatus').textContent = "Baik";
                document.getElementById('teacherStatus').style.color = "#4CAF50";
            }
        }

        function nextQuestion() {
            gameState.currentQuestion++;
            const questions = questionsData[`day${gameState.currentDay}`];
            
            if (gameState.currentQuestion >= questions.length) {
                endDay();
                return;
            }
            
            gameState.timeLeft = 25; // Reduced timer
            document.getElementById('timer').textContent = `‚è∞ ${gameState.timeLeft}s`;
            
            showQuestion();
            startTimer();
        }

        function scheduleStudentQuestions() {
            // Clear any existing timers
            clearAllStudentTimers();
            
            // Set question frequency based on day - MUCH FASTER
            let baseDelay, randomRange;
            
            if (gameState.currentDay === 2) {
                // Day 2: Questions come VERY frequently
                baseDelay = 4000; // 4 seconds base
                randomRange = 3000; // +/- 3 seconds random
            } else if (gameState.currentDay === 3) {
                // Day 3: Questions come EXTREMELY fast
                baseDelay = 2000; // 2 seconds base
                randomRange = 2000; // +/- 2 seconds random
            }
            
            // Schedule first question immediately after starting
            const immediateTimer = setTimeout(() => {
                triggerStudentQuestion();
                scheduleNextStudentQuestion(baseDelay, randomRange);
            }, 1500); // First question appears after 1.5 seconds
            
            gameState.studentQuestionTimers.push(immediateTimer);
        }

        function scheduleNextStudentQuestion(baseDelay, randomRange) {
            if (!gameState.gameActive || gameState.studentQuestionActive) return;
            
            const delay = baseDelay + Math.random() * randomRange;
            const timer = setTimeout(() => {
                if (!gameState.studentQuestionActive && gameState.gameActive) {
                    triggerStudentQuestion();
                    scheduleNextStudentQuestion(baseDelay, randomRange);
                }
            }, delay);
            
            gameState.studentQuestionTimers.push(timer);
        }

        function clearAllStudentTimers() {
            gameState.studentQuestionTimers.forEach(timer => clearTimeout(timer));
            gameState.studentQuestionTimers = [];
        }

        function triggerStudentQuestion() {
            if (!gameState.gameActive || gameState.studentQuestionActive) return;
            
            const dayQuestions = studentQuestions[`day${gameState.currentDay}`];
            if (!dayQuestions || dayQuestions.length === 0) return;
            
            const randomQuestion = dayQuestions[Math.floor(Math.random() * dayQuestions.length)];
            gameState.askingStudent = randomQuestion.student;
            gameState.studentQuestionActive = true;
            
            updateStudentList();
            document.getElementById('questionStudent').textContent = gameState.askingStudent;
            document.getElementById('questionIndicator').style.display = 'block';
            document.getElementById('askBtn').disabled = false;
            highlightAskingStudent();
            
            // Set auto timeout for student question (10 seconds - reduced)
            const autoCloseTimer = setTimeout(() => {
                if (gameState.studentQuestionActive) {
                    gameState.patience -= 10; // Increased penalty
                    studentScores[gameState.askingStudent] = Math.max(0, studentScores[gameState.askingStudent] - 0.3);
                    showFeedback(`‚è∞ ${gameState.askingStudent} menunggu terlalu lama! -10 Kesabaran, nilai turun`, false);
                    closeStudentQuestion();
                }
            }, 10000); // Reduced from 15 seconds
            
            gameState.studentQuestionTimers.push(autoCloseTimer);
        }

        function highlightAskingStudent() {
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                if (item.textContent.includes(gameState.askingStudent)) {
                    item.classList.add('has-question');
                }
            });
        }

        function answerStudentQuestion() {
            if (!gameState.askingStudent) return;
            
            const dayQuestions = studentQuestions[`day${gameState.currentDay}`];
            const question = dayQuestions.find(q => q.student === gameState.askingStudent);
            
            if (!question) return;
            
            stopTimer();
            
            document.getElementById('studentQuestionContent').innerHTML = `
                <h3>${question.student} bertanya:</h3>
                <p style="font-size: 18px; margin: 10px 0;">"${question.question}"</p>
            `;
            
            const optionsDiv = document.getElementById('studentQuestionOptions');
            optionsDiv.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'control-btn';
                button.style.width = '100%';
                button.style.margin = '5px 0';
                button.textContent = option;
                button.onclick = () => checkStudentAnswer(index, question);
                optionsDiv.appendChild(button);
            });
            
            document.getElementById('studentQuestionOverlay').style.display = 'flex';
            document.getElementById('askBtn').disabled = true;
        }

        function checkStudentAnswer(selectedIndex, question) {
            const isCorrect = selectedIndex === question.correct;
            
            if (isCorrect) {
                studentScores[gameState.askingStudent] = Math.min(10, studentScores[gameState.askingStudent] + 0.5);
                gameState.teacherScore += 15;
                gameState.studentQuestionsAnswered++;
                gameState.patience = Math.min(100, gameState.patience + 10);
                showFeedback(`‚úÖ Jawaban benar untuk ${gameState.askingStudent}! +15 Poin & nilai siswa naik!`, true);
            } else {
                gameState.patience -= 15; // Increased penalty
                studentScores[gameState.askingStudent] = Math.max(0, studentScores[gameState.askingStudent] - 0.5);
                showFeedback(`‚ùå Jawaban salah untuk ${gameState.askingStudent}. -15 Kesabaran, nilai siswa turun!`, false);
            }
            
            updateUI();
            closeStudentQuestion();
        }

        function closeStudentQuestion() {
            document.getElementById('studentQuestionOverlay').style.display = 'none';
            document.getElementById('questionIndicator').style.display = 'none';
            
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                item.classList.remove('has-question');
            });
            
            gameState.studentQuestionActive = false;
            gameState.askingStudent = null;
            
            if (gameState.gameActive && (gameState.currentDay === 2 || gameState.currentDay === 3)) {
                startTimer();
            }
        }

        function endDay() {
            gameState.gameActive = false;
            stopTimer();
            clearAllStudentTimers();
            
            if (gameState.autoNextTimer) {
                clearTimeout(gameState.autoNextTimer);
            }
            
            const questions = questionsData[`day${gameState.currentDay}`];
            const dayScore = Math.round((gameState.correctAnswers / questions.length) * 100);
            gameState.teacherScore += dayScore;
            
            document.getElementById('dayQuestionsAnswered').textContent = gameState.questionsAnswered;
            document.getElementById('dayTotalQuestions').textContent = questions.length;
            document.getElementById('dayCorrectAnswers').textContent = gameState.correctAnswers;
            document.getElementById('totalCorrectSoFar').textContent = gameState.totalCorrectAllDays;
            document.getElementById('totalQuestionsSoFar').textContent = gameState.totalQuestionsAllDays;
            document.getElementById('dayStudentQuestions').textContent = gameState.studentQuestionsAnswered;
            document.getElementById('dayScore').textContent = dayScore;
            document.getElementById('totalTeacherScore').textContent = gameState.teacherScore;
            
            document.getElementById('dayCompleteOverlay').style.display = 'flex';
            updateUI();
            
            // Check if performance is too poor to continue
            if (gameState.totalQuestionsAllDays >= 10) {
                const correctRate = (gameState.totalCorrectAllDays / gameState.totalQuestionsAllDays) * 100;
                if (correctRate < 30) {
                    showFeedback("‚ö†Ô∏è PERINGATAN: Performa Anda sangat buruk! Risiko dipecat tinggi!", false);
                }
            }
        }

        function autoNextDay() {
            document.getElementById('dayCompleteOverlay').style.display = 'none';
            
            if (gameState.currentDay >= 3) {
                gameState.currentDay++;
                updateUI();
                showFeedback("‚úÖ Semua materi selesai! Siap untuk ujian hari 4!", true);
                setTimeout(() => {
                    startExamDay();
                }, 2000);
            } else {
                gameState.currentDay++;
                gameState.currentQuestion = 0;
                gameState.questionsAnswered = 0;
                gameState.correctAnswers = 0;
                gameState.studentQuestionsAnswered = 0;
                gameState.studentQuestionActive = false;
                gameState.askingStudent = null;
                
                updateUI();
                document.getElementById('questionText').textContent = `Hari ${gameState.currentDay} dimulai! Klik "Mulai Hari" untuk melanjutkan.`;
                document.getElementById('startDayBtn').disabled = false;
                document.getElementById('askBtn').disabled = true;
                document.getElementById('restartBtn').style.display = 'none';
                
                setTimeout(() => {
                    startDay();
                }, 1000);
            }
        }

        function startTimer() {
            if (gameState.timerActive) return;
            
            gameState.timerActive = true;
            gameState.timeLeft = 25; // Reduced timer
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = `‚è∞ ${gameState.timeLeft}s`;
                
                if (gameState.timeLeft <= 0) {
                    timeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timerActive = false;
        }

        function timeUp() {
            stopTimer();
            gameState.patience -= 25; // Increased penalty
            showFeedback("‚è∞ Waktu habis! -25 Kesabaran", false);
            
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach(btn => btn.disabled = true);
            
            clearTimeout(gameState.autoNextTimer);
            gameState.autoNextTimer = setTimeout(() => {
                nextQuestion();
            }, 1500);
            
            updateUI();
        }

        function updateUI() {
            document.getElementById('dayCounter').textContent = `Hari ${gameState.currentDay}/4`;
            document.getElementById('topicDisplay').textContent = gameState.currentDay === 4 ? "UJIAN NASIONAL" : 
                gameState.currentDay === 1 ? "Permutasi & Kombinasi" :
                gameState.currentDay === 2 ? "Peluang" : "Limit Fungsi";
            
            document.getElementById('patienceValue').textContent = `${gameState.patience}%`;
            document.getElementById('moraleValue').textContent = gameState.morale;
            
            const questions = questionsData[`day${gameState.currentDay}`] || [];
            document.getElementById('questionsAnswered').textContent = `${gameState.questionsAnswered}/${questions.length}`;
            
            // Update total correct display
            document.getElementById('totalCorrectDisplay').textContent = `${gameState.totalCorrectAllDays}/20`;
            document.getElementById('totalCorrectValue').textContent = gameState.totalCorrectAllDays;
            
            // Calculate average score
            const average = gameState.totalQuestionsAllDays > 0 ? 
                Math.round((gameState.totalCorrectAllDays / gameState.totalQuestionsAllDays) * 100) : 0;
            document.getElementById('averageScore').textContent = `${average}%`;
            
            document.getElementById('scoreValue').textContent = gameState.teacherScore;
            document.getElementById('teacherScore').style.display = 'block';
            
            updateStudentList();
            updateRanking();
            checkCriticalPerformance();
        }

        function updateStudentList() {
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '';
            
            students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-item';
                
                if (gameState.askingStudent === student) {
                    div.classList.add('has-question');
                }
                
                if (gameState.caughtStudents.includes(student)) {
                    div.classList.add('sent-bk');
                    div.innerHTML = `
                        <strong>${student}</strong><br>
                        <small>Pemahaman: ${studentScores[student].toFixed(1)}K</small><br>
                        <small style="color: #4CAF50;">‚úÖ Sudah dikirim BK</small>
                    `;
                } else if (gameState.cheatedStudents.includes(student)) {
                    div.classList.add('truant');
                    div.innerHTML = `
                        <strong>${student}</strong><br>
                        <small>Pemahaman: ${studentScores[student].toFixed(1)}K</small><br>
                        <small style="color: #FF9800;">‚ö†Ô∏è Dapat contekan</small>
                    `;
                } else {
                    div.innerHTML = `
                        <strong>${student}</strong><br>
                        <small>Pemahaman: ${studentScores[student].toFixed(1)}K</small>
                    `;
                }
                
                if (gameState.askingStudent === student) {
                    div.onclick = () => answerStudentQuestion();
                }
                
                studentList.appendChild(div);
            });
        }

        function updateRanking() {
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            
            const sortedStudents = [...students].sort((a, b) => studentScores[b] - studentScores[a]);
            
            sortedStudents.forEach((student, index) => {
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.innerHTML = `
                    <span>${index + 1}. ${student}</span>
                    <span>${studentScores[student].toFixed(1)}K</span>
                `;
                rankingList.appendChild(div);
            });
        }

        function showFeedback(message, isCorrect) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.style.display = 'block';
            
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 3000);
        }

        // ========================
        // DAY 4 EXAM FUNCTIONS
        // ========================

        function startExamDay() {
            gameState.examActive = true;
            gameState.currentDay = 4;
            gameState.examTimeLeft = 120;
            gameState.remainingActions = 4;
            
            calculateExamResults();
            document.querySelector('.main-grid').style.display = 'none';
            document.querySelector('.game-controls').style.display = 'none';
            
            updateExamStats();
            document.getElementById('examOverlay').style.display = 'flex';
            document.getElementById('riskIndicator').style.display = 'block';
            updateRiskIndicator();
            startExamTimer();
        }

        function startExamTimer() {
            updateExamTimeDisplay();
            
            gameState.examTimerInterval = setInterval(() => {
                gameState.examTimeLeft--;
                updateExamTimeDisplay();
                
                if (gameState.examTimeLeft <= 0) {
                    clearInterval(gameState.examTimerInterval);
                    finishExam();
                }
            }, 1000);
        }

        function updateExamTimeDisplay() {
            const hours = Math.floor(gameState.examTimeLeft / 60);
            const minutes = gameState.examTimeLeft % 60;
            const timeString = `${hours}:${minutes.toString().padStart(2, '0')}`;
            
            document.getElementById('examTimeLeft').textContent = timeString;
            document.getElementById('patrolTimeLeft').textContent = timeString;
            document.getElementById('roamTimeLeft').textContent = timeString;
        }

        function calculateExamResults() {
            gameState.examResults = [];
            
            students.forEach(student => {
                // Base score depends on teaching quality (correct answers)
                const teachingQuality = Math.min(1, gameState.totalCorrectAllDays / 20);
                let baseScore = (studentScores[student] - 4.0) * 40 * teachingQuality;
                baseScore = Math.max(0, Math.min(60, baseScore));
                
                // If teaching was poor, students perform worse
                const variation = (Math.random() - 0.5) * 40;
                let examScore = Math.max(0, Math.min(100, baseScore + 40 + variation));
                
                // Apply penalty for poor teaching
                if (gameState.totalCorrectAllDays < gameState.warningThreshold) {
                    examScore *= 0.6; // 40% penalty for very poor teaching
                } else if (gameState.totalCorrectAllDays < gameState.requiredCorrect) {
                    examScore *= 0.8; // 20% penalty for poor teaching
                }
                
                // Bonus for excellent teaching
                if (gameState.totalCorrectAllDays >= gameState.perfectBonus) {
                    examScore *= 1.2; // 20% bonus for excellent teaching
                    examScore = Math.min(100, examScore);
                }
                
                const passed = examScore >= 60;
                const cheating = gameState.cheatedStudents.includes(student);
                
                gameState.examResults.push({
                    student,
                    score: examScore,
                    passed,
                    cheating
                });
            });
        }

        function updateExamStats() {
            const results = gameState.examResults;
            const avgScore = results.reduce((sum, r) => sum + r.score, 0) / results.length;
            document.getElementById('examAvgScore').textContent = avgScore.toFixed(1);
            
            const passedCount = results.filter(r => r.passed).length;
            const passRate = (passedCount / results.length) * 100;
            document.getElementById('examPassRate').textContent = `${passRate.toFixed(0)}%`;
            
            // Calculate risk based on teaching performance
            const correctRate = (gameState.totalCorrectAllDays / 20) * 100;
            let risk = 30; // Base risk
            
            if (correctRate < 40) {
                risk = 80; // High risk for very poor teaching
            } else if (correctRate < 60) {
                risk = 60; // Medium risk for poor teaching
            } else if (correctRate < 75) {
                risk = 40; // Moderate risk for average teaching
            } else {
                risk = 20; // Low risk for good teaching
            }
            
            const cheatingCount = results.filter(r => r.cheating).length;
            risk = Math.min(100, risk + (cheatingCount * 20)); // Increased penalty for cheating
            
            gameState.riskLevel = risk;
            document.getElementById('examRisk').textContent = `${risk.toFixed(0)}%`;
            
            return { avgScore, passRate, risk, cheatingCount, correctRate };
        }

        function updateRiskIndicator() {
            const stats = updateExamStats();
            document.getElementById('riskValue').textContent = `${stats.risk.toFixed(0)}%`;
        }

        function startPatrol() {
            if (gameState.remainingActions <= 0) {
                showFeedback("‚è∞ Tidak ada waktu tersisa untuk patroli!", false);
                return;
            }
            
            gameState.examTimeLeft -= 30;
            gameState.remainingActions--;
            updateExamTimeDisplay();
            
            document.getElementById('examOverlay').style.display = 'none';
            document.getElementById('patrolOverlay').style.display = 'flex';
            spawnTruantNPC();
        }

        function spawnTruantNPC() {
            const patrolContent = document.getElementById('patrolContent');
            const randomNPC = npcStudents[Math.floor(Math.random() * npcStudents.length)];
            const randomScore = (3.0 + Math.random() * 2.0).toFixed(1);
            
            patrolContent.innerHTML = `
                <div style="background: #ffebee; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>üëÆ Ketahuan Bolos!</h3>
                    <p><strong>${randomNPC}</strong> (Siswa NPC) ketahuan bermain di toilet saat ujian.</p>
                    <p>Nilai rata-rata: ${randomScore}</p>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="control-btn" style="background: #2196F3;" onclick="sendNPCToBK('${randomNPC}')">
                            Kirim ke BK<br><small>+10 Skor Guru</small>
                        </button>
                        <button class="control-btn" style="background: #FF9800;" onclick="ignoreNPC('${randomNPC}')">
                            Biarkan saja<br><small>Tidak ada efek</small>
                        </button>
                    </div>
                </div>
                <p style="text-align: center; color: #666; margin-top: 20px;">
                    ‚ö†Ô∏è Siswa NPC tidak mempengaruhi nilai siswa utama
                </p>
            `;
        }

        function sendNPCToBK(npcName) {
            gameState.teacherScore += 10;
            showFeedback(`‚úÖ ${npcName} dikirim BK! +10 Skor Guru`, true);
            document.getElementById('scoreValue').textContent = gameState.teacherScore;
            setTimeout(spawnTruantNPC, 1000);
        }

        function ignoreNPC(npcName) {
            showFeedback(`‚è≠Ô∏è ${npcName} dibiarkan saja`, false);
            setTimeout(spawnTruantNPC, 1000);
        }

        function endPatrol() {
            document.getElementById('patrolOverlay').style.display = 'none';
            document.getElementById('examOverlay').style.display = 'flex';
            updateExamStats();
        }

        function startRoaming() {
            if (gameState.remainingActions <= 0) {
                showFeedback("‚è∞ Tidak ada waktu tersisa untuk jalan-jalan!", false);
                return;
            }
            
            gameState.examTimeLeft -= 30;
            gameState.remainingActions--;
            updateExamTimeDisplay();
            
            document.getElementById('examOverlay').style.display = 'none';
            document.getElementById('roamOverlay').style.display = 'flex';
            document.getElementById('moraleDisplay').textContent = gameState.morale;
        }

        function buyIceCream(flavor) {
            if (gameState.iceCreamBought) {
                showFeedback("üç¶ Sudah beli es krim hari ini!", false);
                return;
            }
            
            let boost = 0;
            let message = "";
            
            switch(flavor) {
                case 'vanilla': boost = 10; message = "üç® Vanila segar!"; break;
                case 'chocolate': boost = 15; message = "üç´ Coklat enak!"; break;
                case 'strawberry': boost = 20; message = "üçì Stroberi manis!"; break;
            }
            
            gameState.morale = Math.min(100, gameState.morale + boost);
            gameState.iceCreamBought = true;
            
            document.getElementById('moraleDisplay').textContent = gameState.morale;
            document.getElementById('moraleValue').textContent = gameState.morale;
            showFeedback(`${message} +${boost} Semangat`, true);
        }

        function endRoaming() {
            document.getElementById('roamOverlay').style.display = 'none';
            document.getElementById('examOverlay').style.display = 'flex';
        }

        function finishExam() {
            clearInterval(gameState.examTimerInterval);
            
            const stats = updateExamStats();
            
            // Check if teaching was too poor
            let keepJob = true;
            let reason = "";
            
            // AUTOMATIC FAILURE CONDITIONS:
            if (gameState.totalCorrectAllDays <= 4) {
                // If only 4 or fewer correct answers out of 20
                keepJob = false;
                reason = "Hanya " + gameState.totalCorrectAllDays + " jawaban benar dari 20 soal. Mengajar buruk!";
            } else if (gameState.totalCorrectAllDays < gameState.warningThreshold) {
                // If less than warning threshold (8)
                keepJob = false;
                reason = gameState.totalCorrectAllDays + " jawaban benar dari 20. Performa mengajar tidak memadai!";
            } else if (stats.passRate < 50) {
                // If pass rate is below 50%
                keepJob = false;
                reason = "Tingkat kelulusan hanya " + stats.passRate.toFixed(0) + "%. Siswa tidak siap ujian!";
            } else if (stats.risk > 70) {
                // If risk is too high
                keepJob = false;
                reason = "Risiko dipecat terlalu tinggi (" + stats.risk.toFixed(0) + "%)";
            }
            
            // Check cheating
            const cheatingCaught = Math.random() * 100 < stats.risk;
            if (cheatingCaught && gameState.cheatedStudents.length > 0) {
                keepJob = false;
                reason = "Ketahuan memberi contekan! " + gameState.cheatedStudents.length + " siswa ketahuan mencontek.";
            }
            
            // Calculate final pass rate with adjustments
            let finalPassRate = stats.passRate;
            
            // Apply bonuses/penalties based on teaching quality
            if (gameState.totalCorrectAllDays >= gameState.perfectBonus) {
                finalPassRate += 20; // Big bonus for excellent teaching
            } else if (gameState.totalCorrectAllDays >= gameState.requiredCorrect) {
                finalPassRate += 10; // Good bonus for meeting requirements
            } else if (gameState.totalCorrectAllDays >= gameState.warningThreshold) {
                finalPassRate -= 10; // Penalty for borderline performance
            } else {
                finalPassRate -= 30; // Severe penalty for poor performance
            }
            
            // Apply score bonus
            const scoreBonus = Math.floor(gameState.teacherScore / 10);
            finalPassRate += scoreBonus;
            
            // Final check: must have at least required correct answers AND decent pass rate
            if (keepJob && gameState.totalCorrectAllDays >= gameState.requiredCorrect && finalPassRate >= 70) {
                keepJob = true;
            } else if (keepJob) {
                keepJob = false;
                if (gameState.totalCorrectAllDays < gameState.requiredCorrect) {
                    reason = "Hanya " + gameState.totalCorrectAllDays + " jawaban benar (minimum 12 diperlukan).";
                } else {
                    reason = "Tingkat kelulusan hanya " + finalPassRate.toFixed(0) + "% (minimum 70% diperlukan).";
                }
            }
            
            // Store final result for restart popup
            gameState.finalResult = {
                keepJob,
                cheatingCaught,
                stats,
                finalPassRate,
                reason
            };
            
            showExamResults(keepJob, cheatingCaught, stats, finalPassRate, reason);
        }

        function showExamResults(keepJob, cheatingCaught, stats, finalPassRate, reason) {
            document.getElementById('examOverlay').style.display = 'none';
            
            const resultContainer = document.getElementById('resultContainer');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            
            if (keepJob) {
                resultContainer.style.background = '#e8f5e9';
                resultTitle.textContent = "üéâ SELAMAT! ANDA TETAP JADI GURU!";
                resultTitle.style.color = "#2E7D32";
                resultMessage.innerHTML = `
                    <p><strong>Anda berhasil mempertahankan pekerjaan!</strong></p>
                    <p>üìä <strong>Statistik Akhir:</strong></p>
                    <p>‚úÖ Jawaban Benar: ${gameState.totalCorrectAllDays}/20 (${Math.round((gameState.totalCorrectAllDays/20)*100)}%)</p>
                    <p>üéì Tingkat Kelulusan: ${finalPassRate.toFixed(0)}%</p>
                    <p>üèÜ Skor Guru: ${gameState.teacherScore}</p>
                    ${cheatingCaught ? "<p>‚ö†Ô∏è Ada masalah kecil, tapi kepala sekolah memaafkan Anda.</p>" : 
                      gameState.totalCorrectAllDays >= gameState.perfectBonus ? 
                      "<p>üåü <strong>PERFORMAN LUAR BIASA!</strong> Mengajar sempurna!</p>" : 
                      gameState.totalCorrectAllDays >= gameState.requiredCorrect ?
                      "<p>üëç <strong>Kinerja baik!</strong> Anda memenuhi standar minimum.</p>" : ""}
                `;
            } else {
                resultContainer.style.background = '#ffebee';
                resultTitle.textContent = "üò¢ ANDA DIPECAT!";
                resultTitle.style.color = "#C62828";
                resultMessage.innerHTML = `
                    <p><strong>Kepala sekolah memutuskan untuk memecat Anda!</strong></p>
                    <p>üìâ <strong>Alasan:</strong> ${reason}</p>
                    <p>üìä <strong>Statistik Akhir:</strong></p>
                    <p>‚úÖ Jawaban Benar: ${gameState.totalCorrectAllDays}/20 (${Math.round((gameState.totalCorrectAllDays/20)*100)}%)</p>
                    <p>‚ùå Minimum diperlukan: 12/20 (60%)</p>
                    <p>üéì Tingkat Kelulusan: ${finalPassRate.toFixed(0)}%</p>
                    <p>üèÜ Skor Guru: ${gameState.teacherScore}</p>
                    ${cheatingCaught ? 
                    `<p>‚õî <strong>Ketahuan memberi contekan!</strong> ${gameState.cheatedStudents.length} siswa ketahuan mencontek.</p>` : 
                    gameState.totalCorrectAllDays <= 4 ?
                    `<p>üíÄ <strong>KINERJA BENCANA!</strong> Hanya ${gameState.totalCorrectAllDays} jawaban benar dari 20 soal.</p>` :
                    gameState.totalCorrectAllDays < 8 ?
                    `<p>‚ö†Ô∏è <strong>Mengajar sangat buruk!</strong> Siswa tidak belajar apa-apa.</p>` : ""}
                `;
            }
            
            resultMessage.innerHTML += `
                <hr style="margin: 20px 0;">
                <h3>üìã Detail Hasil Ujian:</h3>
                <p>Rata-rata nilai siswa: ${stats.avgScore.toFixed(1)}</p>
                <p>Semangat guru akhir: ${gameState.morale}</p>
                <p>Kesabaran akhir: ${gameState.patience}%</p>
                ${gameState.caughtStudents.length > 0 ? `<p>Siswa dikirim BK: ${gameState.caughtStudents.length} orang</p>` : ''}
            `;
            
            document.getElementById('resultOverlay').style.display = 'flex';
            
            // Show restart popup after 2 seconds
            setTimeout(() => {
                showRestartPopup();
            }, 2000);
        }

        // ========================
        // RESTART POPUP FUNCTIONS
        // ========================

        function showRestartPopup() {
            // Update high score if needed
            if (gameState.teacherScore > highScore) {
                highScore = gameState.teacherScore;
                localStorage.setItem('mathTeacherHighScore', highScore);
            }
            
            document.getElementById('highScoreValue').textContent = highScore;
            
            const restartTitle = document.getElementById('restartTitle');
            if (gameState.finalResult && gameState.finalResult.keepJob) {
                restartTitle.textContent = "üèÜ SELAMAT! ANDA MENANG!";
                restartTitle.style.color = "#FFD700";
            } else {
                restartTitle.textContent = "üò¢ GAME OVER - ANDA DIPECAT";
                restartTitle.style.color = "#FF6B6B";
            }
            
            const finalStats = document.getElementById('finalStats');
            finalStats.innerHTML = `
                <h3 style="margin-bottom: 10px;">üìä STATISTIK AKHIR</h3>
                <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">
                    Jawaban Benar: <span style="color: #FFD700;">${gameState.totalCorrectAllDays}/20</span>
                </p>
                <p style="font-size: 20px; margin: 10px 0;">
                    Skor Akhir: <strong>${gameState.teacherScore}</strong>
                </p>
                ${gameState.finalResult ? `<p>Tingkat Kelulusan: <strong>${gameState.finalResult.finalPassRate.toFixed(0)}%</strong></p>` : ''}
            `;
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div>üèÜ Skor Tertinggi</div>
                    <div style="font-size: 20px; font-weight: bold;">${highScore}</div>
                </div>
                <div class="stat-item">
                    <div>üòä Kesabaran Akhir</div>
                    <div style="font-size: 20px; font-weight: bold;">${gameState.patience}%</div>
                </div>
                <div class="stat-item">
                    <div>üí™ Semangat Akhir</div>
                    <div style="font-size: 20px; font-weight: bold;">${gameState.morale}</div>
                </div>
                <div class="stat-item">
                    <div>‚úÖ Jawaban Benar</div>
                    <div style="font-size: 20px; font-weight: bold;">${gameState.totalCorrectAllDays}/20</div>
                </div>
            `;
            
            const achievementBadge = document.getElementById('achievementBadge');
            if (gameState.totalCorrectAllDays >= 18) {
                achievementBadge.style.display = 'block';
                achievementBadge.innerHTML = `
                    <h4>üèÖ GURU TERBAIK!</h4>
                    <p>üéØ <strong>PERFORMAN SEMPURNA</strong></p>
                    <p>${gameState.totalCorrectAllDays}/20 jawaban benar!</p>
                `;
            } else if (gameState.totalCorrectAllDays >= 15) {
                achievementBadge.style.display = 'block';
                achievementBadge.innerHTML = `
                    <h4>üèÖ PENCAPAIAN TINGGI!</h4>
                    <p>‚≠ê <strong>GURU HEBAT</strong></p>
                    <p>${gameState.totalCorrectAllDays}/20 jawaban benar!</p>
                `;
            } else if (gameState.totalCorrectAllDays >= 12) {
                achievementBadge.style.display = 'block';
                achievementBadge.innerHTML = `
                    <h4>üéñÔ∏è PENCAPAIAN BAIK!</h4>
                    <p>üëç <strong>GURU KOMPETEN</strong></p>
                    <p>${gameState.totalCorrectAllDays}/20 jawaban benar!</p>
                `;
            } else {
                achievementBadge.style.display = 'none';
            }
            
            document.getElementById('restartPopup').style.display = 'flex';
        }

        function confirmRestart() {
            document.getElementById('restartPopup').style.display = 'none';
            document.getElementById('resultOverlay').style.display = 'none';
            restartGame();
        }

        function declineRestart() {
            document.getElementById('restartPopup').style.display = 'none';
            
            const resultMessage = document.getElementById('resultMessage');
            resultMessage.innerHTML += `
                <hr style="margin: 20px 0;">
                <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.1); border-radius: 10px;">
                    <h3>üôè Terima Kasih Telah Bermain!</h3>
                    <p>Skor Tertinggi Anda: <strong>${highScore}</strong></p>
                    <p>Jawaban Benar Terbaik: <strong>${Math.max(gameState.totalCorrectAllDays, localStorage.getItem('mathTeacherBestCorrect') || 0)}/20</strong></p>
                    <p>Permainan telah berakhir. Refresh halaman untuk mulai baru.</p>
                </div>
            `;
            
            // Save best correct answers
            const bestCorrect = Math.max(gameState.totalCorrectAllDays, localStorage.getItem('mathTeacherBestCorrect') || 0);
            localStorage.setItem('mathTeacherBestCorrect', bestCorrect);
        }

        function restartGame() {
            document.getElementById('restartPopup').style.display = 'none';
            document.getElementById('resultOverlay').style.display = 'none';
            
            gameState.currentDay = 1;
            gameState.currentQuestion = 0;
            gameState.gameActive = false;
            gameState.timerActive = false;
            gameState.questionsAnswered = 0;
            gameState.correctAnswers = 0;
            gameState.totalCorrectAllDays = 0;
            gameState.totalQuestionsAllDays = 0;
            gameState.patience = 100;
            gameState.knowledgePoints = 0;
            gameState.teacherScore = 0;
            gameState.studentQuestionActive = false;
            gameState.askingStudent = null;
            gameState.studentQuestionsAnswered = 0;
            gameState.examActive = false;
            gameState.caughtStudents = [];
            gameState.cheatedStudents = [];
            gameState.morale = 100;
            gameState.riskLevel = 30;
            gameState.iceCreamBought = false;
            gameState.examTimeLeft = 120;
            gameState.remainingActions = 4;
            gameState.finalResult = null;
            
            clearInterval(gameState.timerInterval);
            clearInterval(gameState.examTimerInterval);
            clearAllStudentTimers();
            if (gameState.autoNextTimer) {
                clearTimeout(gameState.autoNextTimer);
            }
            
            students.forEach(student => {
                studentScores[student] = 4.0 + Math.random() * 1.5;
            });
            
            document.getElementById('riskIndicator').style.display = 'none';
            document.getElementById('dayCompleteOverlay').style.display = 'none';
            document.getElementById('questionIndicator').style.display = 'none';
            
            document.querySelector('.main-grid').style.display = 'grid';
            document.querySelector('.game-controls').style.display = 'flex';
            document.getElementById('examTimer').style.display = 'none';
            
            updateUI();
            document.getElementById('questionText').textContent = "Selamat datang! Klik 'Mulai Hari' untuk memulai.";
            document.getElementById('startDayBtn').disabled = false;
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('askBtn').disabled = true;
            
            showFeedback("üîÑ Permainan dimulai ulang! Cobalah lebih baik kali ini!", true);
            showDifficultyWarning();
        }

        function showHelp() {
            alert(`üéÆ CARA BERMAIN - MODE SULIT ‚ö†Ô∏è

üèÜ TUJUAN:
- Menjawab minimal 12 dari 20 soal dengan benar
- Menghasilkan tingkat kelulusan minimal 70%
- Tidak ketahuan memberi contekan

üìä SISTEM PENILAIAN:
- Total 20 soal (Hari 1:10, Hari 2:5, Hari 3:5)
- Minimal 12 benar untuk lolos standar
- Jika < 8 benar: OTOMATIS DIPECAT!
- Jika < 12 benar: Risiko tinggi dipecat

‚è∞ PERUBAHAN KESULITAN:
- Waktu soal: 25 detik (dari 30)
- Penalti salah: -20 kesabaran (dari 15)
- Pertanyaan siswa: SANGAT CEPAT (2-7 detik)
- Waktu tunggu siswa: 10 detik (dari 15)

üìà PENGARUH JAWABAN BENAR:
- 0-4 benar: DIPECAT OTOMATIS
- 5-7 benar: Risiko sangat tinggi
- 8-11 benar: Risiko tinggi
- 12-14 benar: Standar minimum
- 15-17 benar: Kinerja baik
- 18-20 benar: Kinerja sempurna + bonus

üéì HARI 4 - UJIAN NASIONAL:
- Nilai siswa tergantung kualitas mengajar Anda
- Jika Anda banyak salah, nilai siswa turun drastis
- Patroli: +10 skor per siswa NPC
- Jalan-jalan: Tingkatkan semangat

üí° TIPS UNTUK MENANG:
1. Fokus jawab soal dengan BENAR, bukan cepat
2. Jawab pertanyaan siswa untuk naikkan nilai mereka
3. Jaga kesabaran di atas 30%
4. Targetkan minimal 3 benar per hari
5. Hari 1 sangat penting (10 soal!)

üèÜ HIGH SCORE:
- Skor tertinggi: ${highScore}
- Skor disimpan di browser

‚ö†Ô∏è PERINGATAN:
Game ini SANGAT SULIT! Hanya guru terbaik yang akan bertahan!`);
        }

        // Initialize game
        updateUI();
        updateStudentList();
        updateRanking();
        document.getElementById('highScoreValue').textContent = highScore;
        
        // Show difficulty warning on load
        setTimeout(() => {
            showDifficultyWarning();
        }, 1000);
    </script>
</body>
</html>